---
title: "Analysis of the Adverse Health and Economic Impacts of US Storms"
author: "Farina Fayyaz"
date: "2024-02-12"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  cache = TRUE,
  tidy = TRUE,
  tidy.opts = list(
    width.cutoff = 60,  
    keep.blank.line = TRUE
  )
)

```

## 1. Synopsis

This research delves into the NOAA Storm Database, spanning 1950 to November 2011, to assess the impact of severe weather events on human health, property, and crops. Through detailed analysis, we aim to identify which types of events pose the greatest threat to  
1. Population
2. Economy
measured by injuries, fatalities, and economic consequences.  
For more information about Data: [Documentation](https://github.com/FarinaFayyaz/datasciencecoursera/tree/main/05.%20Reproducible%20Research/Course%20Project%202)

## 2. Research Questions
1. Across the United States, which types of events are most harmful with respect to population health?  
2. Across the United States, which types of events have the greatest economic consequences?

## 3. Data Processing

### 3.1. Downloading the Data

```{r Downloading the Data, warning=FALSE, out.width=60}
if (!dir.exists("Data")) {
  dir.create("Data")
  url <-"https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
  download.file(url, destfile = "Data/data.csv")
}
```

### 3.2 Loading Data into R

```{r Loading Data, warning=FALSE}
# Loading dependencies
library(data.table)
# Reading Data from .csv file
data <- read.csv("Data/data.csv")
# Converting to data.table
df <- as.data.table(data)
```

### 3.3 Identifying Column Names

```{r Identifying Column Names}
# Identifying Column Names
names(df)
```

### 3.4 Subsetting the Data

We only need to keep columns "EVTYPE", "INJURIES","FATALITIES","PROPDMG","PROPDMGEXP",
"CROPDMG" and "CROPDMGEXP" for our analysis. Also, we'll only use data where fatalities and injuries occurred.

```{r Subsetting the Data}
# Keep only necessary columns
desired_columns <- c("EVTYPE", "FATALITIES", "INJURIES", "PROPDMG", "PROPDMGEXP", "CROPDMG", "CROPDMGEXP")
stormdata <-df[, ..desired_columns]
# Select rows where either fatalities or injuries are greater than 0
subsetdf <- stormdata[stormdata$FATALITIES > 0 | stormdata$INJURIES > 0, ]
```

### 3.5 Data Cleaning

To calculate Property Damage and Crop Cost we need to clean relevant columns

```{r Data Cleaning}

# Change all damage exponents to uppercase.
cols <- c("PROPDMGEXP", "CROPDMGEXP")
subsetdf[, (cols) := lapply(.SD, toupper), .SDcols = cols]

# Map property damage alphanumeric exponents to numeric values.
propDmgKey <-  c("\"\"" = 10^0, "-" = 10^0, "+" = 10^0, "0" = 10^0, "1" = 10^1, "2" = 10^2, "3" = 10^3, "4" = 10^4, "5" = 10^5, "6" = 10^6,"7" = 10^7, "8" = 10^8, "9" = 10^9, "H" = 10^2, "K" = 10^3,"M" = 10^6, "B" = 10^9)

# Map crop damage alphanumeric exponents to numeric values
cropDmgKey <-  c("\"\"" = 10^0, "?" = 10^0, "0" = 10^0, "K" = 10^3,
                 "M" = 10^6, "B" = 10^9)

# Apply mapping to columns
subsetdf[, PROPDMGEXP := propDmgKey[as.character(PROPDMGEXP)]]
subsetdf[, CROPDMGEXP := cropDmgKey[as.character(CROPDMGEXP)]]

# Replace NA values with 10^0
subsetdf[is.na(PROPDMGEXP), PROPDMGEXP := 10^0]
subsetdf[is.na(CROPDMGEXP), CROPDMGEXP := 10^0]
```

### 3.6 Adding Columns Representing Economic Cost to the Dataset

```{r}
subsetdf <- subsetdf[, .(EVTYPE, FATALITIES, INJURIES, PROPDMG, PROPDMGEXP, PropCost = PROPDMG * PROPDMGEXP, CROPDMG, CROPDMGEXP, CropCost = CROPDMG * CROPDMGEXP)]
```
### 3.7 Calculating Total Damage

```{r}
totalCostDT <- subsetdf[, .(PropCost = sum(PropCost), CropCost = sum(CropCost), Total_Cost = sum(PropCost) + sum(CropCost)), by = .(EVTYPE)]

totalCostDT <- totalCostDT[order(-Total_Cost), ]

totalCostDT <- totalCostDT[1:10, ]

head(totalCostDT, 5)
```

### 3.8 Calculating Total Fatalities and Injuries

```{r}
totalInjuriesDT <- subsetdf[, .(FATALITIES = sum(FATALITIES), INJURIES = sum(INJURIES), totals = sum(FATALITIES) + sum(INJURIES)), by = .(EVTYPE)]

totalInjuriesDT <- totalInjuriesDT[order(-FATALITIES), ]

totalInjuriesDT <- totalInjuriesDT[1:10, ]

head(totalInjuriesDT, 5)
```

## 4. Results

### 4.1 Identifying Events most harmful to Population Health
Before making bar graph, we will melt data.table for easy transformation

```{r}
bad_stuff <- melt(totalInjuriesDT, id.vars="EVTYPE", variable.name = "bad_thing")
head(bad_stuff, 5)
```

### 4.2 Creating the Graph

```{r}
library(ggplot2)
# Create a bar chart for top 10 US killers
healthChart <- ggplot(data = bad_stuff, aes(x = reorder(EVTYPE, -value), y = value, fill = bad_thing)) +
  geom_bar(stat = "identity", position = "dodge") +
  
  # Customize axis labels and appearance
  ylab("Frequency Count") +
  xlab("Event Type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  
  # Set chart title and center it
  ggtitle("Most Harmful Population Events") +
  theme(plot.title = element_text(hjust = 0.5))

# Display the chart
print(healthChart)

```
So, Tornado is the most harmful event with a lot of injuries.

### 4.3 Identifying Events with Most Economic Impact

```{r}

```

